{% extends 'baseEmployeFront.html.twig' %}

{% block title %}Vérification Carte Grise{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/vin.css') }}">
    <style>
        /* Styles communs */
        #car-container {
            width: 100%;
            height: 400px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #car-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        #car-image:hover {
            transform: scale(1.05);
        }
        .welcome-section {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
       
        /* Styles pour les boîtes de vérification */
        .verification-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .verification-box h2 {
            margin-bottom: 1.5rem;
            text-align: center;
        }
       
        /* Styles pour l'API NHTSA */
        .api-response {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
        }
        .loading-spinner {
            display: none;
            width: 2rem;
            height: 2rem;
            border: 0.25rem solid #f3f3f3;
            border-top: 0.25rem solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .vin-details table {
            width: 100%;
            border-collapse: collapse;
        }
        .vin-details th, .vin-details td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .vin-details th {
            background-color: #f2f2f2;
        }
       
        /* Styles pour les résultats de réservation */
        .reservation-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        .reservation-details {
            margin-top: 15px;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion de l'API NHTSA
            const vinFormApi = document.querySelector('.vin-form-api');
            if (vinFormApi) {
                vinFormApi.addEventListener('submit', function(e) {
                    e.preventDefault();
                   
                    const vin = document.getElementById('vin-api').value;
                    const submitBtn = document.getElementById('submit-api');
                    const spinner = document.getElementById('loading-spinner');
                    const responseDiv = document.getElementById('api-response');
                   
                    if (!vin) {
                        alert('Veuillez entrer un numéro VIN');
                        return;
                    }
                   
                    if (vin.length !== 17) {
                        alert('Le numéro VIN doit contenir exactement 17 caractères');
                        return;
                    }
                   
                    submitBtn.disabled = true;
                    spinner.style.display = 'block';
                    responseDiv.style.display = 'none';
                   
                    fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`)
                    .then(response => response.json())
                    .then(data => {
                        let html = '<h4>Résultats de vérification VIN</h4>';
                       
                        if (data.Results && data.Results.length > 0) {
                            const importantFields = [
                                'Make', 'Model', 'Model Year', 'Vehicle Type',
                                'Body Class', 'Engine Manufacturer', 'Displacement (L)',
                                'Fuel Type - Primary', 'Plant Country'
                            ];
                           
                            html += `
                                <div class="alert alert-success">
                                    VIN valide - ${data.Results[0].Value || 'Inconnu'}
                                </div>
                                <div class="vin-details">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Information</th>
                                                <th>Valeur</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                           
                            data.Results.forEach(item => {
                                if (importantFields.includes(item.Variable)) {
                                    html += `
                                        <tr>
                                            <td><strong>${item.Variable}</strong></td>
                                            <td>${item.Value || 'Non spécifié'}</td>
                                        </tr>
                                    `;
                                }
                            });
                           
                            html += `</tbody></table></div>`;
                        } else {
                            html += `<div class="alert alert-danger">Aucune information trouvée</div>`;
                        }
                       
                        responseDiv.innerHTML = html;
                        responseDiv.style.display = 'block';
                    })
                    .catch(error => {
                        responseDiv.innerHTML = `
                            <div class="alert alert-danger">
                                Erreur: ${error.message}
                            </div>
                        `;
                        responseDiv.style.display = 'block';
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        spinner.style.display = 'none';
                    });
                });
            }
           
            // Gestion de la vérification de réservation
            const vinFormReservation = document.querySelector('.vin-form-reservation');
            if (vinFormReservation) {
                vinFormReservation.addEventListener('submit', function(e) {
                    e.preventDefault();
                   
                    const vin = document.getElementById('vin-reservation').value;
                    const submitBtn = document.getElementById('submit-reservation');
                    const spinner = document.getElementById('loading-spinner-reservation');
                    const responseDiv = document.getElementById('reservation-response');
                   
                    if (!vin) {
                        alert('Veuillez entrer un numéro VIN');
                        return;
                    }
                   
                    submitBtn.disabled = true;
                    spinner.style.display = 'block';
                    responseDiv.style.display = 'none';
                   
                    // Simulation de la réponse
                    setTimeout(() => {
                        const hasReservation = Math.random() > 0.5;
                       
                        let html = '<h4>Statut de réservation</h4>';
                       
                        if (hasReservation) {
                            html += `
                                <div class="alert alert-success">
                                    Ce véhicule a une réservation en cours
                                </div>
                                <div class="reservation-details">
                                    <p><strong>Date:</strong> 15/06/2023</p>
                                    <p><strong>Heure:</strong> 14:30</p>
                                    <p><strong>Service:</strong> Révision complète</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="alert alert-warning">
                                    Aucune réservation trouvée pour ce VIN
                                </div>
                            `;
                        }

                        // Add the redirect button
                        html += `
                            <div class="text-center mt-4">
                                <a href="{{ path('app_verif') }}"
                                   class="btn btn-lg"
                                   style="background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
                                          color: white;
                                          padding: 15px 30px;
                                          border-radius: 25px;
                                          text-decoration: none;
                                          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                                          transition: transform 0.3s ease;">
                                    <i class="fas fa-car-mechanic me-2"></i>
                                    Effectuer le contrôle technique
                                </a>
                            </div>
                        `;
                       
                        responseDiv.innerHTML = html;
                        responseDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        spinner.style.display = 'none';

                        // Store VIN in session storage for use in visite.html.twig
                        sessionStorage.setItem('currentVin', vin);
                    }, 1000);
                });
            }
        });
    </script>
{% endblock %}

{% block body %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="welcome-section text-center">
                    <h1>Bienvenue sur le système de vérification</h1>
                    <p class="lead">Suivez les étapes pour effectuer une vérification complète du véhicule</p>
                </div>

                <!-- Boîte 1: Vérification VIN via API NHTSA -->
                <div class="verification-box">
                    <h2>Vérification technique du véhicule</h2>
                    <form class="vin-form-api">
                        <div class="mb-4">
                            <label for="vin-api" class="form-label">Numéro VIN</label>
                            <input type="text"
                                   name="vin"
                                   id="vin-api"
                                   class="form-control"
                                   placeholder="Entrez le numéro VIN (17 caractères)"
                                   required
                                   minlength="17"
                                   maxlength="17"
                                   pattern="[A-HJ-NPR-Z0-9]{17}"
                                   title="17 caractères alphanumériques (sans I, O ou Q)">
                            <small class="text-muted">Exemple: 1HGCM82633A123456</small>
                        </div>

                        <div class="text-center">
                            <button type="submit" id="submit-api" class="btn btn-primary">
                                Vérifier les données techniques
                            </button>
                            <div id="loading-spinner" class="loading-spinner mt-3"></div>
                        </div>
                    </form>

                    <div id="api-response" class="api-response"></div>
                </div>

                <!-- Boîte 2: Vérification de réservation -->
                            <div class="vin-form-container">
            
                                <form method="post" action="{{ path('app_verif_check_vin') }}" class="vin-form">
                                    <div class="mb-4">
                                        <label for="vin" class="form-label">Numéro VIN</label>
                                        <input type="text" 
                                               name="vin" 
                                               id="vin" 
                                               class="form-control" 
                                               value="{{ vin|default('') }}"
                                               placeholder="Entrez le numéro VIN"
                                               required>
                                    </div>
            
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary vin-submit-btn">
                                            Vérifier La Reservation
                                        </button>
                                    </div>
                                </form>
            
                                {% if carteGrise is defined and carteGrise %}
                                    <div class="mt-4">
                                        <h3 class="text-center mb-3">Détails de la Carte Grise</h3>
                                        <div class="card">
                                            <div class="card-body">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Colonne</th>
                                                            <th>Valeur</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for key, value in carteGrise %}
                                                            <tr>
                                                                <td>{{ key }}</td>
                                                                <td>{{ value }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
            
                                {% if error is defined and error %}
                                    <div class="alert alert-danger mt-3">
                                        {{ error }}
                                    </div>
                                {% endif %}
            
                                {% if showButton is defined and showButton and (error is not defined or not error) %}
                                    <div class="text-center mt-4">
                                        <a href="{{ path('app_verif') }}" class="btn btn-primary">
                                            Commencer la vérification
                                        </a>
                                    </div>
                                {% endif %}
            
                                {% if vehicule is defined and vehicule %}
                                    <div class="mt-4">
                                        <h3 class="text-center mb-3">Informations du Véhicule</h3>
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <p><strong>VIN:</strong> {{ vehicule.vin }}</p>
                                                <p><strong>Marque:</strong> {{ vehicule.marque }}</p>
                                                <p><strong>Modèle:</strong> {{ vehicule.modele }}</p>
                                                <p><strong>Année:</strong> {{ vehicule.annee }}</p>
                                            </div>
                                        </div>
            
                                        {% if reservation %}
                                            <h3 class="text-center mb-3">Dernière Réservation</h3>
                                            <div class="card">
                                                <div class="card-body">
                                                    <p><strong>Date:</strong> {{ reservation.dateReservation|date('d/m/Y') }}</p>
                                                    <p><strong>Heure:</strong> {{ reservation.heureReservation }}</p>
                                                    {% if reservation.serviceId %}
                                                        <p><strong>Service:</strong> {{ reservation.serviceId.nom }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Boîte 3: Résultats de la vérification -->

            </div>
        </div>
    </div>
{% endblock %}
